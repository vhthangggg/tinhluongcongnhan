<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T√≠nh L∆∞∆°ng Noel Pro (S·ªë Ch√≠nh X√°c) üéÑ</title>
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --xmas-red: #D42426;
            --xmas-green: #165B33;
            --xmas-gold: #F8B229;
            --xmas-cream: #FBF5E8;
            --dark-text: #2C3E50;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 10px;
            background: #1a3e6e;
            background-image: radial-gradient(circle at 50% 50%, #2c5a9e 0%, #1a3e6e 100%);
            color: var(--dark-text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Snow Effect */
        .snowflakes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .snowflake { position: absolute; color: #fff; font-size: 1em; opacity: 0.8; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(100vh); } }
        .snowflake:nth-child(1) { left: 10%; animation-duration: 10s; }
        .snowflake:nth-child(2) { left: 20%; animation-duration: 12s; font-size: 0.8em; }
        .snowflake:nth-child(3) { left: 70%; animation-duration: 8s; }
        .snowflake:nth-child(4) { left: 40%; animation-duration: 11s; font-size: 1.2em; }

        .container {
            position: relative;
            background: var(--xmas-cream);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 800px;
            border: 4px solid var(--xmas-red);
            margin: 20px auto;
            z-index: 10;
            box-sizing: border-box;
        }

        h2 {
            text-align: center;
            font-family: 'Mountains of Christmas', cursive;
            color: var(--xmas-red);
            font-size: 2.2em;
            margin: 10px 0 20px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .top-decor { text-align: center; font-size: 2em; margin-bottom: -10px; }

        .card-section {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .section-title {
            font-weight: bold;
            color: var(--xmas-green);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            font-size: 1.1em;
        }
        .section-title::before { content: '‚ùÑÔ∏è'; margin-right: 8px; }

        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--xmas-green); }
        
        .input-wrapper { position: relative; }
        .input-wrapper input {
            width: 100%; padding: 12px; padding-right: 60px; 
            border: 2px solid #cdd6e0; border-radius: 8px; 
            box-sizing: border-box; font-size: 16px; 
        }
        .input-wrapper .unit {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            color: var(--xmas-red); font-weight: bold; font-size: 0.9em;
        }
        .helper-text { font-size: 0.9em; color: #666; font-style: italic; margin-top: 5px; margin-left: 5px; }

        button {
            padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s;
        }
        button:active { transform: translateY(2px); }

        .btn-gen { background: var(--xmas-green); color: white; width: 100%; margin-top: 10px; }
        .btn-calc {
            background: linear-gradient(to bottom, var(--xmas-red), #a61b1d); 
            color: white; width: 100%; font-size: 1.3em; padding: 15px;
            border: 2px solid var(--xmas-gold); margin-top: 10px;
        }
        .btn-remove { 
            background: #ffecb3; color: #d35400; 
            padding: 5px 10px; font-size: 0.8em; border-radius: 4px;
        }

        .worker-row {
            display: flex; gap: 8px; margin-bottom: 10px; align-items: center;
            background: #f4f8f4; padding: 10px; border-radius: 8px; 
            border-left: 4px solid var(--xmas-green);
        }
        .stt-circle {
            width: 25px; height: 25px; background: var(--xmas-red); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 0.8em; font-weight: bold; flex-shrink: 0;
        }
        .worker-row input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; border-radius: 8px; overflow: hidden; }
        th { background: var(--xmas-red); color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; background: white; }
        .money-col { font-weight: bold; color: #d35400; text-align: right; }
        .weight-col { color: #555; font-size: 0.9em; }

        .summary-box {
            margin-top: 20px; padding: 15px; background: #e8f5e9; 
            border: 2px dashed var(--xmas-green); border-radius: 10px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--dark-text);
            cursor: pointer;
        }
        .checkbox-container input { margin-right: 10px; transform: scale(1.2); }
    </style>
</head>
<body>

<div class="snowflakes">
    <div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÜ</div><div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÜ</div>
</div>

<div class="container">
    <div class="top-decor">üéÑüéÅüéÖ</div>
    <h2>T√≠nh L∆∞∆°ng Ch√≠nh X√°c ‚ùÑÔ∏è</h2>

    <div class="card-section">
        <div class="section-title">Th√¥ng tin chung</div>
        <div class="input-group">
            <label>üí∞ Gi√° c√¥ng (1.500.000 ƒë/T·∫•n):</label>
            <input type="number" value="1500000" readonly style="background: #eee; color:#666;">
        </div>
        <div class="input-group">
            <label>üì¶ T·ªïng kh·ªëi l∆∞·ª£ng h√†ng (T·∫•n):</label>
            <div class="input-wrapper">
                <input type="number" id="totalTons" step="0.001" placeholder="V√≠ d·ª•: 33.1" oninput="convertKg('totalTons', 'totalKgDisplay')">
                <span class="unit">T·∫§N</span>
            </div>
            <div id="totalKgDisplay" class="helper-text">( = 0 KG )</div>
        </div>
        <div class="input-group">
            <label>üë• T·ªïng s·ªë ng∆∞·ªùi l√∫c b·∫Øt ƒë·∫ßu:</label>
            <input type="number" id="totalWorkers" placeholder="V√≠ d·ª•: 38">
        </div>
    </div>

    <div class="card-section" style="border-color: var(--xmas-green);">
        <div class="section-title">Danh s√°ch ngh·ªâ s·ªõm / Kh√¥ng l√†m ƒë·ªß</div>
        <div class="input-group">
            <label>S·ªë ng∆∞·ªùi kh√¥ng l√†m ƒë·ªß:</label>
            <div style="display: flex; gap: 10px;">
                <input type="number" id="numPartialWorkers" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng..." style="flex:1; padding: 10px; border-radius: 8px; border: 2px solid #ccc;">
                <button type="button" class="btn-gen" style="width: auto; margin-top:0;" onclick="generateInputs()">T·∫°o d√≤ng nh·∫≠p</button>
            </div>
        </div>
        <div id="workerListContainer"></div>
    </div>
    
    <label class="checkbox-container">
        <input type="checkbox" id="expandFullWorkers">
        Li·ªát k√™ chi ti·∫øt t·ª´ng d√≤ng cho "Ng∆∞·ªùi l√†m ƒë·ªß"
    </label>

    <button type="button" class="btn-calc" onclick="calculate()">üéÑ T√çNH TO√ÅN NGAY üéÅ</button>

    <div id="results" style="display:none;">
        <h3 style="text-align: center; color: var(--xmas-red); margin-top:20px; font-family:'Mountains of Christmas'; font-size: 1.8em;">üìú B·∫£ng L∆∞∆°ng Chi Ti·∫øt</h3>
        <div style="overflow-x: auto;">
            <table id="resultTable">
                <thead>
                    <tr>
                        <th>T√™n / Nh√≥m</th>
                        <th>KL l√†m</th>
                        <th style="text-align: right;">Th·ª±c nh·∫≠n (ƒë)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="summary-box" id="summaryText"></div>
    </div>
</div>

<script>
    function convertKg(inputId, displayId) {
        let ton = parseFloat(document.getElementById(inputId).value);
        let display = document.getElementById(displayId);
        if (!isNaN(ton)) {
            display.innerText = `( = ${(ton * 1000).toLocaleString()} KG )`;
        } else {
            display.innerText = "( = 0 KG )";
        }
    }

    function updateRowKg(input) {
        let ton = parseFloat(input.value);
        let span = input.parentElement.parentElement.querySelector('.kg-preview');
        if (!isNaN(ton)) {
            span.innerText = `(${ (ton*1000).toLocaleString() } KG)`;
        } else {
            span.innerText = '';
        }
    }

    function generateInputs() {
        const num = parseInt(document.getElementById('numPartialWorkers').value);
        const container = document.getElementById('workerListContainer');
        if (isNaN(num) || num <= 0) {
            alert("Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng ng∆∞·ªùi!");
            return;
        }
        container.innerHTML = "";
        for(let i = 1; i <= num; i++) {
            let div = document.createElement('div');
            div.className = 'worker-row';
            div.innerHTML = `
                <div class="stt-circle">${i}</div>
                <div style="flex:1;">
                    <input type="text" placeholder="T√™n ng∆∞·ªùi ${i}..." class="p-name" style="width:100%; margin-bottom: 5px;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="number" step="0.001" placeholder="S·ªë T·∫•n d·ª´ng..." class="p-ton" oninput="updateRowKg(this)" style="width: 70%;">
                        <span class="unit" style="font-size:0.8em; font-weight:bold; color: var(--xmas-red);">T·∫§N</span>
                        <button class="btn-remove" onclick="this.closest('.worker-row').remove()">X</button>
                    </div>
                    <div class="kg-preview" style="font-size: 0.8em; color: var(--xmas-green); font-style: italic; margin-top:2px;"></div>
                </div>
            `;
            container.appendChild(div);
        }
    }

    function calculate() {
        const unitPriceTon = 1500000;
        const totalTons = parseFloat(document.getElementById('totalTons').value);
        const totalWorkersCount = parseInt(document.getElementById('totalWorkers').value);
        const expandFull = document.getElementById('expandFullWorkers').checked;

        if (isNaN(totalTons) || isNaN(totalWorkersCount) || totalTons <= 0 || totalWorkersCount <= 0) {
            alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
            return;
        }

        let partials = [];
        const rows = document.querySelectorAll('.worker-row');
        for (let row of rows) {
            let nameInput = row.querySelector('.p-name').value;
            let tonInput = parseFloat(row.querySelector('.p-ton').value);
            if (nameInput && !isNaN(tonInput) && tonInput > 0) {
                if (tonInput >= totalTons) {
                    alert(`L·ªói: Ng∆∞·ªùi "${nameInput}" c√≥ s·ªë T·∫•n l√†m vi·ªác kh√¥ng h·ª£p l·ªá.`);
                    return;
                }
                partials.push({ name: nameInput, stopTon: tonInput });
            }
        }

        partials.sort((a, b) => a.stopTon - b.stopTon);
        let milestones = [0, ...new Set(partials.map(p => p.stopTon)), totalTons].sort((a, b) => a - b);
        let workerWages = {}; 

        for (let i = 0; i < milestones.length - 1; i++) {
            let start = milestones[i];
            let end = milestones[i+1];
            let weight = end - start;
            let workersStoppedBefore = partials.filter(p => p.stopTon <= start + 0.00001).length;
            let activeWorkersCount = totalWorkersCount - workersStoppedBefore;
            
            if (activeWorkersCount <= 0) continue;

            let moneyPerPerson = (weight * unitPriceTon) / activeWorkersCount;

            partials.forEach(p => {
                if (p.stopTon >= end - 0.00001) { 
                    workerWages[p.name] = (workerWages[p.name] || 0) + moneyPerPerson;
                }
            });
            workerWages['__LOYAL_ONE__'] = (workerWages['__LOYAL_ONE__'] || 0) + moneyPerPerson;
        }

        const tbody = document.querySelector('#resultTable tbody');
        tbody.innerHTML = '';
        let grandTotalPaid = 0;
        let loyalCount = totalWorkersCount - partials.length;

        partials.forEach(p => {
            let amount = workerWages[p.name] || 0;
            grandTotalPaid += amount;
            tbody.insertAdjacentHTML('beforeend', `<tr>
                <td>${p.name}</td>
                <td class="weight-col">${p.stopTon.toLocaleString()} T·∫•n</td>
                <td class="money-col">${Math.round(amount).toLocaleString('vi-VN')} ƒë</td>
            </tr>`);
        });

        if (loyalCount > 0) {
            let loyalAmount = workerWages['__LOYAL_ONE__'] || 0;
            grandTotalPaid += (loyalAmount * loyalCount);

            if (expandFull) {
                for (let k = 1; k <= loyalCount; k++) {
                    tbody.insertAdjacentHTML('beforeend', `<tr style="background-color: #fff8e1;">
                        <td>‚≠ê Ng∆∞·ªùi l√†m ƒë·ªß ${k}</td>
                        <td class="weight-col">ƒê·ªß (${totalTons.toLocaleString()} T·∫•n)</td>
                        <td class="money-col">${Math.round(loyalAmount).toLocaleString('vi-VN')} ƒë</td>
                    </tr>`);
                }
            } else {
                tbody.insertAdjacentHTML('beforeend', `<tr style="background-color: #fff8e1;">
                    <td style="font-weight:bold; color:var(--xmas-green);">‚≠ê ${loyalCount} Ng∆∞·ªùi l√†m ƒë·ªß</td>
                    <td class="weight-col">ƒê·ªß (${totalTons.toLocaleString()} T·∫•n)</td>
                    <td class="money-col">${Math.round(loyalAmount).toLocaleString('vi-VN')} ƒë <small>(m·ªói ng∆∞·ªùi)</small></td>
                </tr>`);
            }
        }

        document.getElementById('results').style.display = 'block';
        document.getElementById('results').scrollIntoView({ behavior: 'smooth' });

        let totalRevenue = totalTons * unitPriceTon;
        document.getElementById('summaryText').innerHTML = `
            <div>üí∞ T·ªïng qu·ªπ l∆∞∆°ng: <strong>${Math.round(totalRevenue).toLocaleString('vi-VN')} ƒë</strong></div>
            <div style="margin-top:5px;">üéÅ T·ªïng th·ª±c chi: <strong>${Math.round(grandTotalPaid).toLocaleString('vi-VN')} ƒë</strong></div>
            <div style="margin-top:5px; color:green">‚ú® Ch√™nh l·ªách (s·ªë l·∫ª): <strong>${Math.round(totalRevenue - grandTotalPaid).toLocaleString('vi-VN')} ƒë</strong></div>
        `;
    }
</script>

</body>
</html>
